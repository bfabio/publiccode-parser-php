on:
  release:
    types: [published]

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v5
        with:
          ref: main

      - uses: shivammathur/setup-php@v2
      - uses: actions/setup-go@v5
        with:
          go-version: "1.24"

      - name: Build shared library
        run: make build

      - run: |
          if ! git diff --quiet -- lib/libpubliccode-parser.so; then
            git config user.name "${GITHUB_ACTOR}"
            git config user.email "${GITHUB_ACTOR}@users.noreply.github.com"

            git add lib/libpubliccode-parser.*
            git commit -m "ci: update lib/libpubliccode-parser.so [skip ci]"
            git push
          else
            echo "No changes in lib/libpubliccode-parser.so"
          fi

      - name: Update Packagist
        run: |
          curl -XPOST -H'content-type:application/json' \
            "https://packagist.org/api/update-package?username=bfabio&apiToken=${{ secrets.PACKAGIST_API_TOKEN }}" \
            -d'{"repository":{"url":"https://github.com/bfabio/publiccode-parser-php"}}'
